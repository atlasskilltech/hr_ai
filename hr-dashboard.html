<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HR Analytics Dashboard - Attendance Reports</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
      <h1>üìä HR Analytics Dashboard</h1>
      <p>Comprehensive Attendance Report Generation System</p>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="number">4</div>
        <div class="label">Report Types</div>
      </div>
      <div class="stat-card">
        <div class="number">DB</div>
        <div class="label">Cycle Selection</div>
      </div>
      <div class="stat-card">
        <div class="number">AI</div>
        <div class="label">Powered Analysis</div>
      </div>
      <div class="stat-card">
        <div class="number">‚ö°</div>
        <div class="label">Real-time Reports</div>
      </div>
    </div>

    <!-- Reports Section -->
    <div class="reports-section">
      <h2 class="section-title">
        üìã Generate Reports
      </h2>

      <div class="report-cards">
        <!-- Staff Report Card -->
        <div class="report-card">
          <h3>üë§ Staff Individual Report</h3>
          <p class="description">
            Generate comprehensive attendance analysis for a single employee including cycle-wise breakdown, date-wise status details, and AI-powered insights.
          </p>

          <form id="staffReportForm">
            <div class="form-group">
              <label for="staff_select">Select Staff Member *</label>
              <div class="searchable-select" id="staffSelectContainer">
                <input type="text" class="search-input" id="staff_search" placeholder="Search by name or ID..." autocomplete="off">
                <div class="dropdown-list" id="staffDropdown"></div>
              </div>
              <input type="hidden" id="staff_id" name="staff_id">
              <div class="hint">Type to search or scroll to select</div>
            </div>

            <div class="form-group">
              <label for="staff_cycle_select">Select Specific Cycles (Optional)</label>
              <div class="multi-select-container">
                <div class="searchable-select" id="staffCycleSelectContainer">
                  <input type="text" class="search-input" id="staff_cycle_search" 
                         placeholder="Search and select cycles..." autocomplete="off">
                  <div class="dropdown-list" id="staffCycleDropdown"></div>
                </div>
                <div class="selected-items" id="selectedStaffCycleList"></div>
              </div>
              <div class="hint">Leave empty to use the number of cycles below, or select specific cycles from database</div>
            </div>

            <div class="form-group">
              <label for="staff_cycles">Number of Cycles (if not selecting specific)</label>
              <input type="number" id="staff_cycles" name="cycles" value="0"  placeholder="0">
              <div class="hint">Default: 6 cycles (6 months) - Used only if no specific cycles selected above</div>
            </div>

            <div class="button-group">
              <button type="submit" class="btn btn-primary">
                Generate Report
              </button>
            </div>

            <div class="status-message" id="staffStatus"></div>
          </form>

          <div class="examples">
            <div class="title">üí° Example Use Cases:</div>
            <div class="example-list">
              ‚Ä¢ Performance review preparation<br>
              ‚Ä¢ Individual attendance audit<br>
              ‚Ä¢ Regularization verification<br>
              ‚Ä¢ Employee recognition
            </div>
          </div>
        </div>

        <!-- Department Report Card -->
        <div class="report-card">
          <h3>üè¢ Department Report</h3>
          <p class="description">
            Generate department-wide attendance analysis including all staff members, cycle-wise summary, staff before/after table, and aggregate metrics.
          </p>

          <form id="departmentReportForm">
            <div class="form-group">
              <label for="department_select">Select Department *</label>
              <div class="searchable-select" id="deptSelectContainer">
                <input type="text" class="search-input" id="dept_search" placeholder="Search by department name..." autocomplete="off">
                <div class="dropdown-list" id="deptDropdown"></div>
              </div>
              <input type="hidden" id="department_id" name="department_id">
              <div class="hint">Type to search or scroll to select</div>
            </div>

            <div class="form-group">
              <label for="dept_staff_select">Select Staff (Optional)</label>
              <div class="multi-select-container">
                <div class="searchable-select" id="deptStaffSelectContainer">
                  <input type="text" class="search-input" id="dept_staff_search" placeholder="First select a department..." autocomplete="off" disabled>
                  <div class="dropdown-list" id="deptStaffDropdown"></div>
                </div>
                <div class="selected-items" id="selectedDeptStaffList"></div>
              </div>
              <div class="hint">Leave empty to include all department staff, or select specific staff members</div>
            </div>

            <div class="form-group">
              <label for="dept_cycle_select">Select Specific Cycles (Optional)</label>
              <div class="multi-select-container">
                <div class="searchable-select" id="deptCycleSelectContainer">
                  <input type="text" class="search-input" id="dept_cycle_search" 
                         placeholder="Search and select cycles..." autocomplete="off">
                  <div class="dropdown-list" id="deptCycleDropdown"></div>
                </div>
                <div class="selected-items" id="selectedDeptCycleList"></div>
              </div>
              <div class="hint">Leave empty to use the number of cycles below, or select specific cycles from database</div>
            </div>

            <div class="form-group">
              <label for="dept_cycles">Number of Cycles (if not selecting specific)</label>
              <input type="number" id="dept_cycles" name="cycles" value="0"  placeholder="0">
              <div class="hint">Default: 6 cycles (6 months) - Used only if no specific cycles selected above</div>
            </div>

            <div class="button-group">
              <button type="submit" class="btn btn-primary">
                Generate Report
              </button>
            </div>

            <div class="status-message" id="deptStatus"></div>
          </form>

          <div class="examples">
            <div class="title">üí° Example Use Cases:</div>
            <div class="example-list">
              ‚Ä¢ Department performance review<br>
              ‚Ä¢ Resource planning<br>
              ‚Ä¢ Budget allocation<br>
              ‚Ä¢ Team balancing decisions
            </div>
          </div>
        </div>

        <!-- Staff Comparison Report Card -->
        <div class="report-card">
          <h3>‚öñÔ∏è Staff Comparison Report</h3>
          <p class="description">
            Compare multiple staff members side-by-side with overall summary table, cycle-wise comparison, and performance analysis.
          </p>

          <form id="comparisonReportForm">
            <div class="form-group">
              <label for="comp_staff_select">Select Staff Members (minimum 2) *</label>
              <div class="multi-select-container">
                <div class="searchable-select" id="compStaffSelectContainer">
                  <input type="text" class="search-input" id="comp_staff_search" placeholder="Search and select staff members..." autocomplete="off">
                  <div class="dropdown-list" id="compStaffDropdown"></div>
                </div>
                <div class="selected-items" id="selectedStaffList"></div>
              </div>
              <div class="hint">Select 2 or more staff members to compare</div>
            </div>

            <div class="form-group">
              <label for="comp_cycle_select">Select Specific Cycles (Optional)</label>
              <div class="multi-select-container">
                <div class="searchable-select" id="compCycleSelectContainer">
                  <input type="text" class="search-input" id="comp_cycle_search" 
                         placeholder="Search and select cycles..." autocomplete="off">
                  <div class="dropdown-list" id="compCycleDropdown"></div>
                </div>
                <div class="selected-items" id="selectedCompCycleList"></div>
              </div>
              <div class="hint">Leave empty to use the number of cycles below, or select specific cycles from database</div>
            </div>

            <div class="form-group">
              <label for="comp_cycles">Number of Cycles (if not selecting specific)</label>
              <input type="number" id="comp_cycles" name="cycles" value="0"  placeholder="0">
              <div class="hint">Default: 6 cycles (6 months) - Used only if no specific cycles selected above</div>
            </div>

            <div class="button-group">
              <button type="submit" class="btn btn-primary">
                Generate Report
              </button>
            </div>

            <div class="status-message" id="compStatus"></div>
          </form>

          <div class="examples">
            <div class="title">üí° Example Use Cases:</div>
            <div class="example-list">
              ‚Ä¢ Promotion decisions<br>
              ‚Ä¢ Performance benchmarking<br>
              ‚Ä¢ Team member comparison<br>
              ‚Ä¢ Recognition programs
            </div>
          </div>
        </div>

        <!-- Department Comparison Report Card -->
        <div class="report-card">
          <h3>üè¢‚öñÔ∏è Department Comparison Report</h3>
          <p class="description">
            Compare multiple departments side-by-side with overall summary table, cycle-wise comparison, and cross-department performance analysis.
          </p>

          <form id="deptComparisonReportForm">
            <div class="form-group">
              <label for="comp_dept_select">Select Departments (minimum 2) *</label>
              <div class="multi-select-container">
                <div class="searchable-select" id="compDeptSelectContainer">
                  <input type="text" class="search-input" id="comp_dept_search" placeholder="Search and select departments..." autocomplete="off">
                  <div class="dropdown-list" id="compDeptDropdown"></div>
                </div>
                <div class="selected-items" id="selectedDeptList"></div>
              </div>
              <div class="hint">Select 2 or more departments to compare</div>
            </div>

            <div class="form-group">
              <label for="comp_dept_cycle_select">Select Specific Cycles (Optional)</label>
              <div class="multi-select-container">
                <div class="searchable-select" id="compDeptCycleSelectContainer">
                  <input type="text" class="search-input" id="comp_dept_cycle_search" 
                         placeholder="Search and select cycles..." autocomplete="off">
                  <div class="dropdown-list" id="compDeptCycleDropdown"></div>
                </div>
                <div class="selected-items" id="selectedCompDeptCycleList"></div>
              </div>
              <div class="hint">Leave empty to use the number of cycles below, or select specific cycles from database</div>
            </div>

            <div class="form-group">
              <label for="comp_dept_cycles">Number of Cycles (if not selecting specific)</label>
              <input type="number" id="comp_dept_cycles" name="cycles" value="0"  placeholder="0">
              <div class="hint">Default: 6 cycles (6 months) - Used only if no specific cycles selected above</div>
            </div>

            <div class="button-group">
              <button type="submit" class="btn btn-primary">
                Generate Report
              </button>
            </div>

            <div class="status-message" id="deptCompStatus"></div>
          </form>

          <div class="examples">
            <div class="title">üí° Example Use Cases:</div>
            <div class="example-list">
              ‚Ä¢ Cross-department performance<br>
              ‚Ä¢ Resource allocation decisions<br>
              ‚Ä¢ Budget comparison<br>
              ‚Ä¢ Organizational benchmarking
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Reports -->
      <div class="recent-reports">
        <h3>üïí Recently Generated Reports</h3>
        <div class="report-list" id="recentReportsList">
          <div style="text-align: center; color: #94a3b8; padding: 20px;">
            No reports generated yet. Create your first report above!
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p><strong>HR Analytics System v2.0.0</strong></p>
      <p>Powered by Node.js, MySQL, and Mistral AI</p>
      <p style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
        ¬© 2025 - Confidential and Proprietary
      </p>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.origin;
    let staffList = [];
    let departmentList = [];
    let selectedComparisonStaff = [];
    let selectedComparisonDepartments = [];
    let recentReports = [];
    
    // Variables for department staff selection
    let selectedDepartmentStaff = [];
    let departmentStaffList = [];

    // Variables for cycle selection
    let cyclesList = [];
    let selectedStaffCycles = [];
    let selectedDeptCycles = [];
    let selectedCompCycles = [];
    let selectedCompDeptCycles = [];

    // Initialize dashboard
    async function initDashboard() {
      try {
        await Promise.all([
          loadStaffList(),
          loadDepartmentList(),
          loadCyclesList()
        ]);
        loadRecentReports();
        setupEventListeners();
      } catch (error) {
        console.error('Dashboard initialization error:', error);
      }
    }

    // Load staff list from API
    async function loadStaffList() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/staff/list`);
        const data = await response.json();
        if (data.success) {
          staffList = data.data;
          console.log(`‚úÖ Loaded ${staffList.length} staff members`);
        }
      } catch (error) {
        console.error('Error loading staff:', error);
      }
    }

    // Load department list from API
    async function loadDepartmentList() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/departments/list`);
        const data = await response.json();
        if (data.success) {
          departmentList = data.data;
          console.log(`‚úÖ Loaded ${departmentList.length} departments`);
        }
      } catch (error) {
        console.error('Error loading departments:', error);
      }
    }

    // Load cycles list from API
    async function loadCyclesList() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/cycles/list`);
        const data = await response.json();
        if (data.success) {
          cyclesList = data.data.map(cycle => ({
            cycle_id: cycle.cycle_id,
            cycle_name: `${cycle.cycle_month_name} ${cycle.cycle_year_no} (${formatDate(cycle.cycle_start_date)} - ${formatDate(cycle.cycle_end_date)})`,
            start_date: cycle.cycle_start_date,
            end_date: cycle.cycle_end_date,
            month_name: cycle.cycle_month_name,
            year_no: cycle.cycle_year_no
          }));
          console.log(`‚úÖ Loaded ${cyclesList.length} cycles`);
        }
      } catch (error) {
        console.error('Error loading cycles:', error);
        cyclesList = [];
      }
    }

    // Helper function to format dates
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return `${date.getDate()} ${date.toLocaleString('en', {month: 'short'})} ${date.getFullYear()}`;
    }

    // Load staff for selected department
    async function loadDepartmentStaff(departmentId) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/departments/${departmentId}/staff`);
        const data = await response.json();
        if (data.success) {
          departmentStaffList = data.data;
          selectedDepartmentStaff = [];
          document.getElementById('dept_staff_search').disabled = false;
          document.getElementById('dept_staff_search').placeholder = `Search from ${departmentStaffList.length} staff members...`;
          renderSelectedDepartmentStaff();
          console.log(`‚úÖ Loaded ${departmentStaffList.length} staff for department ${departmentId}`);
        }
      } catch (error) {
        console.error('Error loading department staff:', error);
        departmentStaffList = [];
      }
    }

    // Add staff to department report selection
    function addDepartmentStaffToSelection(staffId) {
      if (!selectedDepartmentStaff.includes(staffId)) {
        selectedDepartmentStaff.push(staffId);
        renderSelectedDepartmentStaff();
      }
    }

    // Remove staff from department report selection
    function removeDepartmentStaffFromSelection(staffId) {
      selectedDepartmentStaff = selectedDepartmentStaff.filter(id => id !== staffId);
      renderSelectedDepartmentStaff();
    }

    // Render selected department staff badges
    function renderSelectedDepartmentStaff() {
      const container = document.getElementById('selectedDeptStaffList');
      if (!container) return;
      
      if (selectedDepartmentStaff.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = selectedDepartmentStaff.map(staffId => {
        const staff = departmentStaffList.find(s => s.staff_id === staffId);
        if (!staff) return '';
        return `
          <div class="selected-item">
            <span>${staff.staff_name}</span>
            <span class="remove" onclick="removeDepartmentStaffFromSelection(${staffId})">√ó</span>
          </div>
        `;
      }).join('');
    }

    // Cycle Selection Functions
    function addCycleToSelection(cycleId, containerPrefix = 'staff') {
      const selectedArray = getSelectedCyclesArray(containerPrefix);
      if (!selectedArray.includes(cycleId)) {
        selectedArray.push(cycleId);
        renderSelectedCycles(containerPrefix);
      }
    }

    function removeCycleFromSelection(cycleId, containerPrefix = 'staff') {
      const selectedArray = getSelectedCyclesArray(containerPrefix);
      const index = selectedArray.indexOf(cycleId);
      if (index > -1) {
        selectedArray.splice(index, 1);
        renderSelectedCycles(containerPrefix);
      }
    }

    function getSelectedCyclesArray(containerPrefix) {
      switch(containerPrefix) {
        case 'staff': return selectedStaffCycles;
        case 'dept': return selectedDeptCycles;
        case 'comp': return selectedCompCycles;
        case 'comp_dept': return selectedCompDeptCycles;
        default: return [];
      }
    }

    function renderSelectedCycles(containerPrefix = 'staff') {
      const selectedArray = getSelectedCyclesArray(containerPrefix);
      let containerId = `selected${capitalize(containerPrefix)}CycleList`;
      const container = document.getElementById(containerId);
      
      if (!container) {
        console.warn(`Container not found: ${containerId}`);
        return;
      }
      
      if (selectedArray.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = selectedArray.map(cycleId => {
        const cycle = cyclesList.find(c => c.cycle_id === cycleId);
        if (!cycle) return '';
        return `
          <div class="selected-item">
            <span>${cycle.cycle_name}</span>
            <span class="remove" onclick="removeCycleFromSelection(${cycleId}, '${containerPrefix}')">√ó</span>
          </div>
        `;
      }).join('');
    }

    function capitalize(str) {
      if (str === 'comp_dept') return 'CompDept';
      if (str === 'dept') return 'Dept';
      if (str === 'comp') return 'Comp';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function setupCycleMultiSelect(searchInputId, dropdownId, containerPrefix) {
      const searchInput = document.getElementById(searchInputId);
      const dropdown = document.getElementById(dropdownId);
      
      if (!searchInput || !dropdown) {
        console.warn(`Elements not found: ${searchInputId} or ${dropdownId}`);
        return;
      }
      
      searchInput.addEventListener('focus', () => {
        renderCycleDropdown(dropdown, cyclesList, searchInput.value, containerPrefix, searchInputId);
        dropdown.classList.add('show');
      });

      searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filtered = cyclesList.filter(cycle => 
          cycle.cycle_name.toLowerCase().includes(searchTerm)
        );
        renderCycleDropdown(dropdown, filtered, searchTerm, containerPrefix, searchInputId);
      });

      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove('show');
        }
      });
    }

    function renderCycleDropdown(dropdown, cycles, searchTerm = '', containerPrefix = 'staff', searchInputId = '') {
      const selectedArray = getSelectedCyclesArray(containerPrefix);
      const availableCycles = cycles.filter(cycle => !selectedArray.includes(cycle.cycle_id));

      if (availableCycles.length === 0) {
        dropdown.innerHTML = '<div class="no-results">No more cycles to select</div>';
        return;
      }

      dropdown.innerHTML = availableCycles.map(cycle => 
        `<div class="dropdown-item" data-value="${cycle.cycle_id}">
          ${cycle.cycle_name}
        </div>`
      ).join('');

      dropdown.querySelectorAll('.dropdown-item').forEach(el => {
        el.addEventListener('click', () => {
          const cycleId = parseInt(el.getAttribute('data-value'));
          addCycleToSelection(cycleId, containerPrefix);
          if (searchInputId) {
            const searchInput = document.getElementById(searchInputId);
            if (searchInput) searchInput.value = '';
          }
          renderCycleDropdown(dropdown, cycles, '', containerPrefix, searchInputId);
        });
      });
    }

    // Setup all event listeners
    function setupEventListeners() {
      // Staff select
      setupSearchableSelect('staff_search', 'staffDropdown', 'staff_id', staffList, 
        (item) => `${item.staff_name} <span class="item-id">(ID: ${item.staff_id})</span>`,
        (item) => item.staff_id
      );

      // Department select with callback to load staff
      setupSearchableSelect('dept_search', 'deptDropdown', 'department_id', departmentList,
        (item) => `${item.department_name} <span class="item-id">(ID: ${item.department_id})</span>`,
        (item) => item.department_id,
        async (departmentId) => {
          await loadDepartmentStaff(departmentId);
        }
      );

      // Department staff multi-select
      setupMultiSelect('dept_staff_search', 'deptStaffDropdown', departmentStaffList, false, true);

      // Cycle multi-selects
      setupCycleMultiSelect('staff_cycle_search', 'staffCycleDropdown', 'staff');
      setupCycleMultiSelect('dept_cycle_search', 'deptCycleDropdown', 'dept');
      setupCycleMultiSelect('comp_cycle_search', 'compCycleDropdown', 'comp');
      setupCycleMultiSelect('comp_dept_cycle_search', 'compDeptCycleDropdown', 'comp_dept');

      // Comparison staff multi-select
      setupMultiSelect('comp_staff_search', 'compStaffDropdown', staffList, false);

      // Comparison department multi-select
      setupMultiSelect('comp_dept_search', 'compDeptDropdown', departmentList, true);

      // Form submissions
      document.getElementById('staffReportForm').addEventListener('submit', handleStaffReportSubmit);
      document.getElementById('departmentReportForm').addEventListener('submit', handleDepartmentReportSubmit);
      document.getElementById('comparisonReportForm').addEventListener('submit', handleComparisonReportSubmit);
      document.getElementById('deptComparisonReportForm').addEventListener('submit', handleDepartmentComparisonReportSubmit);
    }

    // Setup searchable select dropdown
    function setupSearchableSelect(searchInputId, dropdownId, hiddenInputId, dataList, displayFn, valueFn, onSelectCallback) {
      const searchInput = document.getElementById(searchInputId);
      const dropdown = document.getElementById(dropdownId);
      const hiddenInput = document.getElementById(hiddenInputId);

      searchInput.addEventListener('focus', () => {
        renderDropdown(dropdown, dataList, searchInput.value, displayFn, (item) => {
          searchInput.value = item.staff_name || item.department_name;
          hiddenInput.value = valueFn(item);
          dropdown.classList.remove('show');
          
          if (onSelectCallback) {
            onSelectCallback(valueFn(item));
          }
        });
        dropdown.classList.add('show');
      });

      searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filtered = dataList.filter(item => {
          const name = (item.staff_name || item.department_name).toLowerCase();
          const id = String(item.staff_id || item.department_id);
          return name.includes(searchTerm) || id.includes(searchTerm);
        });
        renderDropdown(dropdown, filtered, searchTerm, displayFn, (item) => {
          searchInput.value = item.staff_name || item.department_name;
          hiddenInput.value = valueFn(item);
          dropdown.classList.remove('show');
          
          if (onSelectCallback) {
            onSelectCallback(valueFn(item));
          }
        });
      });

      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove('show');
        }
      });
    }

    // Render dropdown items
    function renderDropdown(dropdown, items, searchTerm, displayFn, onSelectFn) {
      if (items.length === 0) {
        dropdown.innerHTML = '<div class="no-results">No results found</div>';
        return;
      }

      dropdown.innerHTML = items.map(item => 
        `<div class="dropdown-item" data-value="${item.staff_id || item.department_id}">
          ${displayFn(item)}
        </div>`
      ).join('');

      dropdown.querySelectorAll('.dropdown-item').forEach(el => {
        el.addEventListener('click', () => {
          const value = el.getAttribute('data-value');
          const item = items.find(i => String(i.staff_id || i.department_id) === value);
          if (item) onSelectFn(item);
        });
      });
    }

    // Setup multi-select for comparison
    function setupMultiSelect(searchInputId, dropdownId, dataList, isDepartment = false, isDeptStaff = false) {
      const searchInput = document.getElementById(searchInputId);
      const dropdown = document.getElementById(dropdownId);
      const selectedList = document.getElementById(
        isDeptStaff ? 'selectedDeptStaffList' : 
        isDepartment ? 'selectedDeptList' : 
        'selectedStaffList'
      );
      const selectedArray = isDeptStaff ? selectedDepartmentStaff :
                            isDepartment ? selectedComparisonDepartments : 
                            selectedComparisonStaff;

      searchInput.addEventListener('focus', () => {
        const currentDataList = isDeptStaff ? departmentStaffList : dataList;
        renderMultiSelectDropdown(dropdown, currentDataList, searchInput.value, isDepartment, isDeptStaff);
        dropdown.classList.add('show');
      });

      searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        const currentDataList = isDeptStaff ? departmentStaffList : dataList;
        const filtered = currentDataList.filter(item => {
          const name = (item.staff_name || item.department_name).toLowerCase();
          const id = String(item.staff_id || item.department_id);
          const itemId = item.staff_id || item.department_id;
          const notSelected = !selectedArray.includes(itemId);
          return notSelected && (name.includes(searchTerm) || id.includes(searchTerm));
        });
        renderMultiSelectDropdown(dropdown, filtered, searchTerm, isDepartment, isDeptStaff);
      });

      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove('show');
        }
      });

      function renderMultiSelectDropdown(dropdown, items, searchTerm = '', isDept = false, isDStaff = false) {
        const availableItems = items.filter(item => {
          const itemId = item.staff_id || item.department_id;
          return !selectedArray.includes(itemId);
        });

        if (availableItems.length === 0) {
          dropdown.innerHTML = `<div class="no-results">No more ${isDept ? 'departments' : 'staff'} to select</div>`;
          return;
        }

        dropdown.innerHTML = availableItems.map(item => {
          const name = item.staff_name || item.department_name;
          const id = item.staff_id || item.department_id;
          return `<div class="dropdown-item" data-value="${id}">
            ${name} <span class="item-id">(ID: ${id})</span>
          </div>`;
        }).join('');

        dropdown.querySelectorAll('.dropdown-item').forEach(el => {
          el.addEventListener('click', () => {
            const itemId = parseInt(el.getAttribute('data-value'));
            if (isDStaff) {
              addDepartmentStaffToSelection(itemId);
            } else if (isDept) {
              addDepartmentToComparison(itemId);
            } else {
              addStaffToComparison(itemId);
            }
            searchInput.value = '';
            renderMultiSelectDropdown(dropdown, items, '', isDept, isDStaff);
          });
        });
      }
    }

    // Add staff to comparison list
    function addStaffToComparison(staffId) {
      if (!selectedComparisonStaff.includes(staffId)) {
        selectedComparisonStaff.push(staffId);
        renderSelectedStaff();
      }
    }

    // Remove staff from comparison list
    function removeStaffFromComparison(staffId) {
      selectedComparisonStaff = selectedComparisonStaff.filter(id => id !== staffId);
      renderSelectedStaff();
    }

    // Render selected staff badges
    function renderSelectedStaff() {
      const container = document.getElementById('selectedStaffList');
      if (selectedComparisonStaff.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = selectedComparisonStaff.map(staffId => {
        const staff = staffList.find(s => s.staff_id === staffId);
        if (!staff) return '';
        return `
          <div class="selected-item">
            <span>${staff.staff_name}</span>
            <span class="remove" onclick="removeStaffFromComparison(${staffId})">√ó</span>
          </div>
        `;
      }).join('');
    }

    // Add department to comparison list
    function addDepartmentToComparison(deptId) {
      if (!selectedComparisonDepartments.includes(deptId)) {
        selectedComparisonDepartments.push(deptId);
        renderSelectedDepartments();
      }
    }

    // Remove department from comparison list
    function removeDepartmentFromComparison(deptId) {
      selectedComparisonDepartments = selectedComparisonDepartments.filter(id => id !== deptId);
      renderSelectedDepartments();
    }

    // Render selected departments badges
    function renderSelectedDepartments() {
      const container = document.getElementById('selectedDeptList');
      if (selectedComparisonDepartments.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = selectedComparisonDepartments.map(deptId => {
        const dept = departmentList.find(d => d.department_id === deptId);
        if (!dept) return '';
        return `
          <div class="selected-item">
            <span>${dept.department_name}</span>
            <span class="remove" onclick="removeDepartmentFromComparison(${deptId})">√ó</span>
          </div>
        `;
      }).join('');
    }

    // Show status message
    function showStatus(formId, type, message) {
      const statusEl = document.getElementById(formId + 'Status');
      statusEl.className = `status-message ${type}`;
      statusEl.style.display = 'block';
      
      if (type === 'loading') {
        statusEl.innerHTML = `<span class="loading-spinner"></span>${message}`;
      } else {
        statusEl.textContent = message;
      }

      if (type !== 'loading') {
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 5000);
      }
    }

    // Handle staff report submission
    async function handleStaffReportSubmit(e) {
      e.preventDefault();
      
      const staff_id = document.getElementById('staff_id').value;
      const cycles = document.getElementById('staff_cycles').value || 6;

      if (!staff_id) {
        showStatus('staff', 'error', '‚úó Please select a staff member');
        return;
      }

      showStatus('staff', 'loading', 'Generating staff report...');

      try {
        // Build URL with cycle_ids if selected, otherwise use cycles number
        let url = `${API_BASE_URL}/staffAttendanceAnalysisReportUpdate/${staff_id}`;
        if (selectedStaffCycles.length > 0) {
          url += `?cycle_ids=${selectedStaffCycles.join(',')}`;
        } else {
          url += `?cycles=${cycles}`;
        }

        console.log('Staff Report URL:', url);
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const html = await response.text();
        const newWindow = window.open('', '_blank');
        newWindow.document.write(html);
        newWindow.document.close();

        const staff = staffList.find(s => s.staff_id === parseInt(staff_id));
        showStatus('staff', 'success', '‚úì Report generated successfully!');
        addToRecentReports('staff', { 
          staff_id, 
          staff_name: staff?.staff_name, 
          cycles: selectedStaffCycles.length > 0 ? selectedStaffCycles : cycles,
          cycle_ids: selectedStaffCycles.length > 0 ? selectedStaffCycles : null
        });
      } catch (error) {
        showStatus('staff', 'error', '‚úó Error: ' + error.message);
      }
    }

    // Handle department report submission
    async function handleDepartmentReportSubmit(e) {
      e.preventDefault();
      
      const department_id = document.getElementById('department_id').value;
      const cycles = document.getElementById('dept_cycles').value || 6;

      if (!department_id) {
        showStatus('dept', 'error', '‚úó Please select a department');
        return;
      }

      showStatus('dept', 'loading', 'Generating department report...');

      try {
        let response;
        
        // Build URL with cycle_ids if selected
        let url = `${API_BASE_URL}/departmentAttendanceReport/${department_id}`;
        const params = new URLSearchParams();
        
        if (selectedDeptCycles.length > 0) {
          params.append('cycle_ids', selectedDeptCycles.join(','));
        } else {
          params.append('cycles', cycles);
        }
        
        url += `?${params.toString()}`;
        
        // If staff are selected, use POST with staff_ids
        if (selectedDepartmentStaff.length > 0) {
          const body = { 
            staff_ids: selectedDepartmentStaff
          };
          
          if (selectedDeptCycles.length > 0) {
            body.cycle_ids = selectedDeptCycles;
          } else {
            body.cycles = parseInt(cycles);
          }
          
          response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          });
        } else {
          // Otherwise use GET for all staff
          response = await fetch(url);
        }
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const html = await response.text();
        const newWindow = window.open('', '_blank');
        newWindow.document.write(html);
        newWindow.document.close();

        const dept = departmentList.find(d => d.department_id === parseInt(department_id));
        showStatus('dept', 'success', '‚úì Report generated successfully!');
        addToRecentReports('department', { 
          department_id, 
          department_name: dept?.department_name, 
          cycles: selectedDeptCycles.length > 0 ? selectedDeptCycles : cycles,
          cycle_ids: selectedDeptCycles.length > 0 ? selectedDeptCycles : null,
          staff_ids: selectedDepartmentStaff.length > 0 ? [...selectedDepartmentStaff] : null
        });
      } catch (error) {
        showStatus('dept', 'error', '‚úó Error: ' + error.message);
      }
    }

    // Handle staff comparison report submission
    async function handleComparisonReportSubmit(e) {
      e.preventDefault();
      
      const cycles = document.getElementById('comp_cycles').value || 6;

      if (selectedComparisonStaff.length < 2) {
        showStatus('comp', 'error', '‚úó Please select at least 2 staff members');
        return;
      }

      showStatus('comp', 'loading', 'Generating comparison report...');

      try {
        const body = {
          staff_ids: selectedComparisonStaff
        };
        
        // Add cycle_ids if selected, otherwise add cycles number
        if (selectedCompCycles.length > 0) {
          body.cycle_ids = selectedCompCycles;
        } else {
          body.cycles = parseInt(cycles);
        }
        
        console.log('Staff Comparison Request:', body);
        
        const response = await fetch(`${API_BASE_URL}/staffComparisonReport`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const html = await response.text();
        const newWindow = window.open('', '_blank');
        newWindow.document.write(html);
        newWindow.document.close();

        showStatus('comp', 'success', '‚úì Report generated successfully!');
        addToRecentReports('comparison', { 
          staff_ids: [...selectedComparisonStaff], 
          cycles: selectedCompCycles.length > 0 ? selectedCompCycles : cycles,
          cycle_ids: selectedCompCycles.length > 0 ? selectedCompCycles : null
        });
      } catch (error) {
        showStatus('comp', 'error', '‚úó Error: ' + error.message);
      }
    }

    // Handle department comparison report submission
    async function handleDepartmentComparisonReportSubmit(e) {
      e.preventDefault();
      
      const cycles = document.getElementById('comp_dept_cycles').value || 6;

      if (selectedComparisonDepartments.length < 2) {
        showStatus('deptComp', 'error', '‚úó Please select at least 2 departments');
        return;
      }

      showStatus('deptComp', 'loading', 'Generating department comparison report...');

      try {
        const body = {
          department_ids: selectedComparisonDepartments
        };
        
        // Add cycle_ids if selected, otherwise add cycles number
        if (selectedCompDeptCycles.length > 0) {
          body.cycle_ids = selectedCompDeptCycles;
        } else {
          body.cycles = parseInt(cycles);
        }
        
        console.log('Department Comparison Request:', body);
        
        const response = await fetch(`${API_BASE_URL}/departmentComparisonReport`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const html = await response.text();
        const newWindow = window.open('', '_blank');
        newWindow.document.write(html);
        newWindow.document.close();

        showStatus('deptComp', 'success', '‚úì Report generated successfully!');
        addToRecentReports('department_comparison', { 
          department_ids: [...selectedComparisonDepartments], 
          cycles: selectedCompDeptCycles.length > 0 ? selectedCompDeptCycles : cycles,
          cycle_ids: selectedCompDeptCycles.length > 0 ? selectedCompDeptCycles : null
        });
      } catch (error) {
        showStatus('deptComp', 'error', '‚úó Error: ' + error.message);
      }
    }

    // Recent reports functions
    function loadRecentReports() {
      const stored = localStorage.getItem('recentReports');
      if (stored) {
        recentReports = JSON.parse(stored);
        displayRecentReports();
      }
    }

    function saveRecentReports() {
      localStorage.setItem('recentReports', JSON.stringify(recentReports));
    }

    function addToRecentReports(type, params) {
      const report = {
        id: Date.now(),
        type,
        params,
        timestamp: new Date().toISOString()
      };

      recentReports.unshift(report);
      if (recentReports.length > 10) {
        recentReports = recentReports.slice(0, 10);
      }

      saveRecentReports();
      displayRecentReports();
    }

    function displayRecentReports() {
      const container = document.getElementById('recentReportsList');
      
      if (recentReports.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: #94a3b8; padding: 20px;">
            No reports generated yet. Create your first report above!
          </div>
        `;
        return;
      }

      container.innerHTML = recentReports.map(report => {
        const date = new Date(report.timestamp);
        const timeStr = date.toLocaleString();
        
        let title = '';
        let meta = '';

        if (report.type === 'staff') {
          title = `Staff Report - ${report.params.staff_name || 'ID: ' + report.params.staff_id}`;
          const cycleInfo = report.params.cycle_ids ? `${report.params.cycle_ids.length} selected cycles` : `${report.params.cycles || 6} cycles`;
          meta = cycleInfo;
        } else if (report.type === 'department') {
          title = `Department Report - ${report.params.department_name || 'ID: ' + report.params.department_id}`;
          const staffCount = report.params.staff_ids ? report.params.staff_ids.length : 'all';
          const cycleInfo = report.params.cycle_ids ? `${report.params.cycle_ids.length} selected cycles` : `${report.params.cycles || 6} cycles`;
          meta = `${staffCount} staff, ${cycleInfo}`;
        } else if (report.type === 'comparison') {
          title = `Staff Comparison - ${report.params.staff_ids.length} staff members`;
          const cycleInfo = report.params.cycle_ids ? `${report.params.cycle_ids.length} selected cycles` : `${report.params.cycles || 6} cycles`;
          meta = `${report.params.staff_ids.length} staff, ${cycleInfo}`;
        } else if (report.type === 'department_comparison') {
          title = `Department Comparison - ${report.params.department_ids.length} departments`;
          const cycleInfo = report.params.cycle_ids ? `${report.params.cycle_ids.length} selected cycles` : `${report.params.cycles || 6} cycles`;
          meta = `${report.params.department_ids.length} departments, ${cycleInfo}`;
        }

        return `
          <div class="report-item">
            <div class="report-info">
              <div class="title">${title}</div>
              <div class="meta">${timeStr} ‚Ä¢ ${meta}</div>
            </div>
            <div class="report-actions">
              <button class="icon-btn" onclick="regenerateReport(${report.id})">
                üîÑ Regenerate
              </button>
              <button class="icon-btn" onclick="deleteReport(${report.id})">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function regenerateReport(reportId) {
      const report = recentReports.find(r => r.id === reportId);
      if (!report) return;

      if (report.type === 'staff') {
        document.getElementById('staff_id').value = report.params.staff_id;
        document.getElementById('staff_search').value = report.params.staff_name || '';
        document.getElementById('staff_cycles').value = report.params.cycles || 6;
        
        // Restore cycle selection if present
        if (report.params.cycle_ids && Array.isArray(report.params.cycle_ids)) {
          selectedStaffCycles = [...report.params.cycle_ids];
          renderSelectedCycles('staff');
        } else {
          selectedStaffCycles = [];
          renderSelectedCycles('staff');
        }
        
        document.getElementById('staffReportForm').dispatchEvent(new Event('submit'));
        
      } else if (report.type === 'department') {
        document.getElementById('department_id').value = report.params.department_id;
        document.getElementById('dept_search').value = report.params.department_name || '';
        document.getElementById('dept_cycles').value = report.params.cycles || 6;
        
        // Restore cycle selection if present
        if (report.params.cycle_ids && Array.isArray(report.params.cycle_ids)) {
          selectedDeptCycles = [...report.params.cycle_ids];
          renderSelectedCycles('dept');
        } else {
          selectedDeptCycles = [];
          renderSelectedCycles('dept');
        }
        
        // Restore staff selection if any
        if (report.params.staff_ids && report.params.staff_ids.length > 0) {
          loadDepartmentStaff(report.params.department_id).then(() => {
            selectedDepartmentStaff = [...report.params.staff_ids];
            renderSelectedDepartmentStaff();
          });
        }
        
        document.getElementById('departmentReportForm').dispatchEvent(new Event('submit'));
        
      } else if (report.type === 'comparison') {
        selectedComparisonStaff = [...report.params.staff_ids];
        renderSelectedStaff();
        document.getElementById('comp_cycles').value = report.params.cycles || 6;
        
        // Restore cycle selection if present
        if (report.params.cycle_ids && Array.isArray(report.params.cycle_ids)) {
          selectedCompCycles = [...report.params.cycle_ids];
          renderSelectedCycles('comp');
        } else {
          selectedCompCycles = [];
          renderSelectedCycles('comp');
        }
        
        document.getElementById('comparisonReportForm').dispatchEvent(new Event('submit'));
        
      } else if (report.type === 'department_comparison') {
        selectedComparisonDepartments = [...report.params.department_ids];
        renderSelectedDepartments();
        document.getElementById('comp_dept_cycles').value = report.params.cycles || 6;
        
        // Restore cycle selection if present
        if (report.params.cycle_ids && Array.isArray(report.params.cycle_ids)) {
          selectedCompDeptCycles = [...report.params.cycle_ids];
          renderSelectedCycles('comp_dept');
        } else {
          selectedCompDeptCycles = [];
          renderSelectedCycles('comp_dept');
        }
        
        document.getElementById('deptComparisonReportForm').dispatchEvent(new Event('submit'));
      }
    }

    function deleteReport(reportId) {
      if (confirm('Remove this report from recent list?')) {
        recentReports = recentReports.filter(r => r.id !== reportId);
        saveRecentReports();
        displayRecentReports();
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDashboard);
    } else {
      initDashboard();
    }
  </script>
</body>
</html>